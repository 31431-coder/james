<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>åœ–ç‰‡è‰²æº«è¨ˆç®—å™¨</title>
    <style>
      body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
      .container { display: flex; flex-direction: column; gap: 15px; }
      h3 { margin-bottom: 5px; color: #333; }
      
      /* ä¸Šå‚³å€å¡Šç¾åŒ– */
      .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; }
      .upload-area:hover { border-color: #1a73e8; background: #f8f9fa; }
      
      #preview { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; display: none; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
      
      .result-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 5px solid #1a73e8; }
      
      button { 
        background: #1a73e8; color: white; border: none; padding: 10px 20px; 
        border-radius: 4px; cursor: pointer; font-size: 16px; transition: background 0.3s; 
      }
      button:hover { background: #1557b0; }
      button:disabled { background: #ccc; cursor: not-allowed; }
      
      .loading { color: #666; font-style: italic; display: none; }
    </style>
  </head>
  <body>
    <div class="container">
      <h3>ğŸ¨ åœ–ç‰‡è‰²æº«è¨ˆç®—å™¨ (Webç‰ˆ)</h3>
      <p style="font-size: 0.9em; color: #666;">ä¸Šå‚³åœ–ç‰‡ï¼Œè‡ªå‹•åˆ†æå¹³å‡è‰²æº« (Kelvin)</p>
      
      <input type="file" id="fileInput" accept="image/*" style="margin-bottom: 10px;">
      
      <div class="loading" id="msg">æ­£åœ¨åˆ†æåƒç´ ...</div>
      
      <canvas id="canvas" style="display:none;"></canvas>
      <img id="preview" />
      
      <div id="resultArea" style="display:none;">
        <div class="result-box">
          <div style="font-size: 0.9em; color: #555; margin-bottom: 5px;">å¹³å‡è‰²æº« (CCT)</div>
          <div style="font-size: 2em; color: #d93025; font-weight: bold;">
            <span id="cctVal">-</span> K
          </div>
          <div style="font-size:0.9em; color:#555; margin-top: 5px;">
            RGB: <span id="rgbVal">-</span>
          </div>
        </div>
        <br>
        <button id="copyBtn" onclick="copyResult()">ğŸ“‹ è¤‡è£½çµæœ</button>
      </div>
    </div>

    <script>
      let currentCCT = 0;
      let currentRGB = {r:0, g:0, b:0};

      document.getElementById('fileInput').addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;

        var reader = new FileReader();
        var img = new Image();
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        var msg = document.getElementById('msg');
        
        msg.style.display = 'block';
        document.getElementById('resultArea').style.display = 'none';

        reader.onload = function(event) {
          img.onload = function() {
            // ç¸®æ”¾åœ–ç‰‡ä»¥åŠ å¿«è¨ˆç®—é€Ÿåº¦ (é™åˆ¶æœ€å¤§é‚Šé•· 1000px)
            var scale = Math.min(1, 1000 / Math.max(img.width, img.height));
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            
            // ç¹ªè£½åœ–ç‰‡åˆ° Canvas
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            // é¡¯ç¤ºé è¦½
            var preview = document.getElementById('preview');
            preview.src = canvas.toDataURL();
            preview.style.display = 'block';

            // è¨ˆç®—å¹³å‡é¡è‰²
            calculateAverageColor(ctx, canvas.width, canvas.height);
          }
          img.src = event.target.result;
        }
        reader.readAsDataURL(file);
      });

      function calculateAverageColor(ctx, width, height) {
        var imageData = ctx.getImageData(0, 0, width, height);
        var data = imageData.data;
        var r = 0, g = 0, b = 0;
        var count = 0;

        // éæ­·æ‰€æœ‰åƒç´  (å–æ¨£é–“éš” 40)
        for (var i = 0; i < data.length; i += 40) {
          r += data[i];
          g += data[i+1];
          b += data[i+2];
          count++;
        }

        r = Math.round(r / count);
        g = Math.round(g / count);
        b = Math.round(b / count);

        currentRGB = {r:r, g:g, b:b};
        
        // å‘¼å«è‰²æº«è¨ˆç®—å‡½æ•¸
        currentCCT = calculateCCT(r, g, b);
        
        // é¡¯ç¤ºçµæœ
        document.getElementById('cctVal').innerText = Math.round(currentCCT);
        document.getElementById('rgbVal').innerText = `${r}, ${g}, ${b}`;
        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('msg').style.display = 'none';
        
        // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
        var btn = document.getElementById('copyBtn');
        btn.innerText = "ğŸ“‹ è¤‡è£½çµæœ";
        btn.style.background = "#1a73e8";
      }

      // --- æ–°å¢ï¼šè¤‡è£½çµæœåˆ°å‰ªè²¼ç°¿çš„åŠŸèƒ½ (å–ä»£åŸæœ¬çš„ Google Sheet å¯«å…¥) ---
      function copyResult() {
        var btn = document.getElementById('copyBtn');
        // æ ¼å¼ï¼š 5500 K | RGB(255,200,100)
        var textToCopy = `${Math.round(currentCCT)} K\tRGB(${currentRGB.r}, ${currentRGB.g}, ${currentRGB.b})`;
        
        navigator.clipboard.writeText(textToCopy).then(function() {
          btn.innerText = "âœ… å·²è¤‡è£½ï¼";
          btn.style.background = "#0f9d58"; // è®Šç¶ è‰²
          
          setTimeout(function() {
            btn.innerText = "ğŸ“‹ è¤‡è£½çµæœ";
            btn.style.background = "#1a73e8";
          }, 2000);
        }).catch(function(err) {
          alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½");
        });
      }

      // --- è‰²æº«ç®—æ³•æ ¸å¿ƒ ---
      function calculateCCT(r, g, b) {
        var r_norm = r / 255.0;
        var g_norm = g / 255.0;
        var b_norm = b / 255.0;

        function inverseSrgb(c) {
          return (c <= 0.04045) ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
        }

        var r_lin = inverseSrgb(r_norm);
        var g_lin = inverseSrgb(g_norm);
        var b_lin = inverseSrgb(b_norm);

        var X = 0.4124564 * r_lin + 0.3575761 * g_lin + 0.1804375 * b_lin;
        var Y = 0.2126729 * r_lin + 0.7151522 * g_lin + 0.0721750 * b_lin;
        var Z = 0.0193339 * r_lin + 0.1191920 * g_lin + 0.9503041 * b_lin;

        if ((X + Y + Z) === 0) return 0;

        var x = X / (X + Y + Z);
        var y = Y / (X + Y + Z);

        var n = (x - 0.3320) / (0.1858 - y);
        var cct = 449.0 * Math.pow(n, 3) + 3525.0 * Math.pow(n, 2) + 6823.3 * n + 5520.33;
        
        return cct;
      }
    </script>
  </body>
</html>
